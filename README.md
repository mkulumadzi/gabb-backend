# GabbBackend

## Configuration

### General Configuration

The following environment variables are required for basic functionality of the app:

* RACK_ENV _Set to the appropriate development environment_
* GABB_BASE_URL _Points to the application url (eg, http://localhost:9292), for resolving URIs in header responses_

### AWS Configuration

The app uses Amazon S3 for storing image files and for retrieving public and private certificate files for app authentication. Before configuring the app, create an S3 bucket and an AWS user with IAMS privileges for reading and writing on this bucket. Then set up the following variables for AWS configuration:

* GABB_AWS_REGION _Eg, Oregon_
* GABB_AWS_BUCKET _Eg, skeleton-app-development-bucket_
* GABB_AWS_ACCESS_KEY_ID _Access key for the user_
* GABB_AWS_SECRET_ACCESS_KEY _Secret for the user_

### OAuth Configuration

The app uses OAuth for API authentication. To configure:

1. Create a public key certificate file called 'public.pem'
- Create a private key certificate file called 'private.pem', optionally protected by a passphrase
- Create a new bucket on AWS S3 and upload these files

Then configure the following environment variables

* GABB_CERTIFICATE_BUCKET
* GABB_PRIVATE_KEY_PASSPHRASE _Passphrase for the public key file_

### Email Configuration

The app can optionally be configured to send email address verification and password reset emails. The app uses the email service 'Postmark'. To enable emails:

1. Create an account on Postmark using a private domain email address (public domain emails are not allowed to send emails via Postmark)
- Create a sender signature for this email address

Then configure the following environment variables:

* GABB_EMAIL_ENABLED = yes _Set to "yes" if enabled_
* GABB_POSTMARK_EMAIL_ADDRESS _Email address configured in postmark_
* POSTMARK_API_KEY _Sender signature api key generated by Postmark_

## API Documentation

### People

Create a person (note that, if email is enabled, this person will receive automated mail to authenticate their email):

```
POST /person/new

{
	"given_name": "Test",
  "family_name": "Person"
	"username": "username",
	"email": "person@test.com",
	"phone": "555-444-1234",
	"password": "password",
	"address1": "Street Address",
	"city": "City",
	"state": "ST",
	"zip": "11111"
}

Status: 201

Headers:
location = app_root/person/id/{person_id}
```

Log in:

```
POST /login

{
	"username": "username",
	"password": "password"
}

Status: 200

Response body:

{
  "access_token": User OAuth token
  "token_type": "bearer"
  "expires_in": "6220800"
  "person": {
    "_id": {
      "$oid": Person Id
    }-
    "username": "username"
    "given_name": "Test"
    "family_name": "Person"
    "email": "person@test.com"
    "email_address_validated": false
    "phone": "5554441234"
    "address1": "Street Address"
    "city": "City"
    "state": "ST"
    "zip": "11111"
    "updated_at": "2016-03-25T20:28:09.539Z"
    "created_at": "2016-03-25T20:28:09.539Z"
  }
}
```

Get a person record:

```
GET /person/id/{person_id}

Status: 200

Response body:

{
	"_id": {
		"$oid": Person Id
	},
  "username": "username"
  "given_name": "Test"
  "family_name": "Person"
  "email": "person@test.com"
  "email_address_validated": false
  "phone": "5554441234"
  "address1": "Street Address"
  "city": "City"
  "state": "ST"
  "zip": "11111"
  "updated_at": "2016-03-25T20:28:09.539Z"
  "created_at": "2016-03-25T20:28:09.539Z"
}
```

Update a person:

```
POST /person/id/{person_id}

{
	"address1": "Street Address",
	"city": "City",
	"state": "ST",
	"zip": "11111"
}

Status: 204
```

Reset a person's password:

```
POST /person/id/{person_id}/reset_password

{
	"old_password": "password",
	"new_password": "password123"
}

Status: 204
```

Get a collection of people:

```
GET  /people?parameter=value

Status: 200

Response body:

[
	{
  	"_id": {
  		"$oid": Person Id
  	},
    "username": "username"
    "given_name": "Test"
    "family_name": "Person"
    "email": "person@test.com"
    "email_address_validated": false
    "phone": "5554441234"
    "address1": "Street Address"
    "city": "City"
    "state": "ST"
    "zip": "11111"
    "updated_at": "2016-03-25T20:28:09.539Z"
    "created_at": "2016-03-25T20:28:09.539Z"
  }
]
```

Search people:
* Search terms are case-sensitive
* Terms are used to search both name and username records
* If no limit to the number of results is set, the default limit is 25

```
GET /people/search?term=Evan&limit=3

Status: 200

Response body:
[
	{
  	"_id": {
  		"$oid": Person Id
  	},
    "username": "username"
    "given_name": "Test"
    "family_name": "Person"
    "email": "person@test.com"
    "email_address_validated": false
    "phone": "5554441234"
    "address1": "Street Address"
    "city": "City"
    "state": "ST"
    "zip": "11111"
    "updated_at": "2016-03-25T20:28:09.539Z"
    "created_at": "2016-03-25T20:28:09.539Z"
  }
]
```

Find matches for people using a list of email addresses:

```

POST /people/find_matches

{
    "emails": ["person1@test.com", "person2@test.com"]
}

Status: 201

Response body:
[
	{
  	"_id": {
  		"$oid": Person Id
  	},
    "username": "username"
    "given_name": "Test"
    "family_name": "Person"
    "email": "person1@test.com"
    "email_address_validated": false
    "phone": "5554441234"
    "address1": "Street Address"
    "city": "City"
    "state": "ST"
    "zip": "11111"
    "updated_at": "2016-03-25T20:28:09.539Z"
    "created_at": "2016-03-25T20:28:09.539Z"
  }
]
```

### Files

Upload a file to the S3 file store:

```
POST /upload

Contents: Base 64 encoded file

Status: 201
```

Get am image from the S3 file store:

```
GET /image/{image_uuid}

Status: 200

Redirects to a presigned URL for the S3 data store
```
